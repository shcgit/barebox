#!/bin/sh

FILEUPD=informer.upd

if [ -e /dev/serial1 ]; then
	if [ -f /env/bin/wait.txt ]; then
		cp /env/bin/wait.txt /dev/serial1
	fi
fi

if [ ! -e /dev/m25p0 ]; then
	echo -e "\e[1;31mSPIFI flash device not found.\e[0m"
	exit
fi

if [ ! -e /dev/m25p1 ]; then
	echo -e "\e[1;31mSPI flash device not found.\e[0m"
	exit
fi

if [ -d /disk ]; then
	echo -e "\e[1;31mUSB function is disabled. Please reset the device.\e[0m"
	exit
fi

mkdir /disk

usb

for i in /dev/disk*.0; do
	if [ ! -e $i ]; then
		exit
	fi

	mount $i fat /disk

	if [ $? == 0 ]; then
		if [ -n $SerialCRC ]; then
			if [ -f /disk/"$SerialCRC".bin ]; then
				cp /disk/"$SerialCRC".bin /disk/"$SerialCRC".bi0
			fi

			cp /dev/m25p1 /disk/"$SerialCRC".bin
			if [ $? == 0 ]; then
				echo -e "\e[1;32mEventlog is copied.\e[0m"
			else
				echo -e "\e[1;31mEventlog is not copied.\e[0m"
			fi
		else
			echo -e "\e[1;31mEventlog is not copied.\e[0m"
		fi

		if [ -f "/disk/$FILEUPD" ]; then
			echo -e "\e[1;32mFound image /disk/$FILEUPD\e[0m"

			# Beep Start
			gpio_direction_output 31 1
			msleep 1000
			gpio_direction_output 31 0

			mmupdate /disk/$FILEUPD

			if [ $? -ge 73 ]; then
				# Beep Stop
				gpio_direction_output 31 1
				msleep 150
				gpio_direction_output 31 0
				msleep 50
				gpio_direction_output 31 1
				msleep 150
				gpio_direction_output 31 0
				msleep 50
				gpio_direction_output 31 1
				msleep 150
				gpio_direction_output 31 0

				echo -e "\e[1;32mDone.\e[0m"

				umount /disk

				echo -e -n "\e[1;32mSystem will be restarted\e[0m: "
				timeout -a 3
				if [ $? == 0 ]; then
					reset
				fi

				exit
			else
				if [ $? == 0 ]; then
				else
					echo -e "\e[1;31mFailed.\e[0m"

					umount /disk

					exit
				fi
			fi
		fi

		umount /disk
	fi
done

echo -e "\e[1;33mNothing to update.\e[0m"
