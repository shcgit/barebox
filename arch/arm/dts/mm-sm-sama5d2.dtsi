/* SPDX-License-Identifier: GPL-2.0+ */
/* SPDX-FileCopyrightText: Alexander Shiyan <shc_work@mail.ru> */

/dts-v1/;

#include <arm/microchip/sama5d2.dtsi>
#include <arm/microchip/sama5d2-pinfunc.h>
#include <dt-bindings/mfd/atmel-flexcom.h>
#include <dt-bindings/gpio/gpio.h>
//#include <dt-bindings/regulator/active-semi,8945a-regulator.h>

#include "sama5d2.dtsi"

/ {
	model = "Mega-Milas MM-SM-SAMA5D2";
	compatible = "milas,mm-sm-sama5d2",
		     "atmel,sama5d27", "atmel,sama5d2", "atmel,sama5";

	aliases {
		i2c0 = &i2c0;
		i2c1 = &i2c1;
		i2c2 = &i2c3;
		i2c3 = &i2c4;
		serial0 = &uart8;
		serial1 = &uart1;
		serial2 = &uart9;
		serial3 = &uart3;
	};

	chosen {
		stdout-path = &uart1;

//		environment {
//			compatible = "barebox,environment";
//			device-path = &sdmmc1;
//			file-path = "barebox.env";
//		};
	};

	clocks {
		slow_xtal {
			clock-frequency = <32768>;
		};

		main_xtal {
			clock-frequency = <12000000>;
		};
	};

//	leds {
//		compatible = "gpio-leds";
//		pinctrl-names = "default";
//		pinctrl-0 = <&pinctrl_led_gpio_default>;
//
//		orange {
//			label = "orange";
//			gpios = <&pioA PIN_PA6 GPIO_ACTIVE_HIGH>;
//			linux,default-trigger = "mmc0";
//		};
//	};
};

&flx1 {
	atmel,flexcom-mode = <ATMEL_FLEXCOM_MODE_TWI>;
	status = "okay";
};

&flx2 {
	atmel,flexcom-mode = <ATMEL_FLEXCOM_MODE_TWI>;
	status = "okay";
};

&flx3 {
	atmel,flexcom-mode = <ATMEL_FLEXCOM_MODE_USART>;
	status = "okay";
};

&flx4 {
	atmel,flexcom-mode = <ATMEL_FLEXCOM_MODE_USART>;
	status = "okay";
};

&i2c0 {
	/* I2C_PM */
	pinctrl-names = "default", "gpio";
	pinctrl-0 = <&pinctrl_i2c0_default>;
	pinctrl-1 = <&pinctrl_i2c0_gpio>;
	sda-gpios = <&pioA PIN_PD29 GPIO_ACTIVE_HIGH>;
	scl-gpios = <&pioA PIN_PD30 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;
	status = "okay";
};

&i2c1 {
	/* I2C_GP */
	pinctrl-names = "default", "gpio";
	pinctrl-0 = <&pinctrl_i2c1_default>;
	pinctrl-1 = <&pinctrl_i2c1_gpio>;
	sda-gpios = <&pioA PIN_PD4 GPIO_ACTIVE_HIGH>;
	scl-gpios = <&pioA PIN_PD5 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;
	status = "okay";
};

&i2c3 {
	//TODO:
};

&i2c4 {
	//TODO:
};

&uart1 {
	/* SER1 */
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart1>;
	atmel,use-dma-rx;
	atmel,use-dma-tx;
	atmel,fifo-size = <32>;
	status = "okay";
};

&uart3 {
	/* SER3 */
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart3>;
	atmel,use-dma-rx;
	atmel,use-dma-tx;
	atmel,fifo-size = <32>;
	status = "okay";
};

&uart8 {
	/* SER0 */
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart8>;
	atmel,use-dma-rx;
	atmel,use-dma-tx;
	atmel,fifo-size = <32>;
	status = "okay";
};

&uart9 {
	/* SER2 */
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart9>;
	atmel,use-dma-rx;
	atmel,use-dma-tx;
	atmel,fifo-size = <32>;
	status = "okay";
};

&watchdog {
	status = "okay";
};

&pioA {
	pinctrl_i2c0_default: i2c0grp-default {
		pinmux = <PIN_PD29__TWD0>,
			 <PIN_PD30__TWCK0>;
		bias-disable;
	};

	pinctrl_i2c0_gpio: i2c0grp-gpio {
		pinmux = <PIN_PD29__GPIO>,
			 <PIN_PD30__GPIO>;
		bias-disable;
	};

	pinctrl_i2c1_default: i2c1grp-default {
		pinmux = <PIN_PD4__TWD1>,
			 <PIN_PD5__TWCK1>;
		bias-disable;
	};

	pinctrl_i2c1_gpio: i2c1grp-gpio {
		pinmux = <PIN_PD4__GPIO>,
			 <PIN_PD5__GPIO>;
		bias-disable;
	};

	pinctrl_uart1: uart1grp {
		pinmux = <PIN_PD2__URXD1>,
			 <PIN_PD3__UTXD1>;
		bias-disable;
	};

	pinctrl_uart3: uart3grp {
		pinmux = <PIN_PC12__URXD3>,
			 <PIN_PC13__UTXD3>;
		bias-disable;
	};

	pinctrl_uart8: uart8grp {
		pinmux = <PIN_PC19__FLEXCOM3_IO1>,
			 <PIN_PC20__FLEXCOM3_IO0>,
			 <PIN_PC21__FLEXCOM3_IO3>,
			 <PIN_PC22__FLEXCOM3_IO4>;
		bias-disable;
	};

	pinctrl_uart9: uart9grp {
		pinmux = <PIN_PD12__FLEXCOM4_IO0>,
			 <PIN_PD13__FLEXCOM4_IO1>,
			 <PIN_PD15__FLEXCOM4_IO3>,
			 <PIN_PD16__FLEXCOM4_IO4>;
		bias-disable;
	};
};

#if 0
&usb0 {
	status = "okay";
};

&sdmmc1 {
	bus-width = <4>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_sdmmc1_default>;
	status = "okay";
};

&spi0 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_spi0_default>;
	status = "disabled";
};

&shutdown_controller {
	atmel,shdwc-debouncer = <976>;
	atmel,wakeup-rtc-timer;

	input@0 {
		reg = <0>;
		atmel,wakeup-type = "low";
	};
};

&i2c0 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c0_default>;
	dmas = <0>, <0>;
};

&i2c1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c1_default>;
	dmas = <0>, <0>;
	i2c-sda-hold-time-ns = <350>;
	status = "okay";

	pmic@5b {
		compatible = "active-semi,act8945a";
		reg = <0x5b>;
		active-semi,vsel-low;

		regulators {
			vdd_1v8_reg: REG_DCDC1 {
				regulator-name = "VDD_1V8";
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-always-on;

				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_FIXED>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_FIXED>;

				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-min-microvolt=<1850000>;
					regulator-suspend-max-microvolt=<1850000>;
					regulator-changeable-in-suspend;
					regulator-mode=<ACT8945A_REGULATOR_MODE_LOWPOWER>;
				};
			};

			vdd_1v2_reg: REG_DCDC2 {
				regulator-name = "VDD_1V2";
				regulator-min-microvolt = <1100000>;
				regulator-max-microvolt = <1300000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_FIXED>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_FIXED>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdd_3v3_reg: REG_DCDC3 {
				regulator-name = "VDD_3V3";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_FIXED>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_FIXED>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdd_fuse_reg: REG_LDO1 {
				regulator-name = "VDD_FUSE";
				regulator-min-microvolt = <2500000>;
				regulator-max-microvolt = <2500000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_NORMAL>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_NORMAL>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdd_3v3_lp_reg: REG_LDO2 {
				regulator-name = "VDD_3V3_LP";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_NORMAL>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_NORMAL>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdd_led_reg: REG_LDO3 {
				regulator-name = "VDD_LED";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_NORMAL>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_NORMAL>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdd_sdhc_1v8_reg: REG_LDO4 {
				regulator-name = "VDD_SDHC_1V8";
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-allowed-modes = <ACT8945A_REGULATOR_MODE_NORMAL>,
							  <ACT8945A_REGULATOR_MODE_LOWPOWER>;
				regulator-initial-mode = <ACT8945A_REGULATOR_MODE_NORMAL>;
				regulator-always-on;

				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};
		};

		charger {
			compatible = "active-semi,act8945a-charger";
			pinctrl-names = "default";
			pinctrl-0 = <&pinctrl_charger_chglev &pinctrl_charger_lbo &pinctrl_charger_irq>;
			interrupt-parent = <&pioA>;
			interrupts = <PIN_PB13 IRQ_TYPE_EDGE_RISING>;

			active-semi,chglev-gpios = <&pioA PIN_PA12 GPIO_ACTIVE_HIGH>;
			active-semi,lbo-gpios = <&pioA PIN_PC8 GPIO_ACTIVE_LOW>;
			active-semi,input-voltage-threshold-microvolt = <6600>;
			active-semi,precondition-timeout = <40>;
			active-semi,total-timeout = <3>;
		};
	};
};

&pioA {
	pinctrl_i2c0_default: i2c0_default {
		pinmux = <PIN_PB31__TWD0>,
			 <PIN_PC0__TWCK0>;
		bias-disable;
	};

	pinctrl_i2c1_default: i2c1_default {
		pinmux = <PIN_PD4__TWD1>,
			 <PIN_PD5__TWCK1>;
		bias-disable;
	};

	pinctrl_led_gpio_default: led_gpio_default {
		pinmux = <PIN_PA6__GPIO>;
		bias-pull-down;
	};

	pinctrl_sdmmc1_default: sdmmc1_default {
		cmd_data {
			pinmux = <PIN_PA28__SDMMC1_CMD>,
				 <PIN_PA18__SDMMC1_DAT0>,
				 <PIN_PA19__SDMMC1_DAT1>,
				 <PIN_PA20__SDMMC1_DAT2>,
				 <PIN_PA21__SDMMC1_DAT3>;
			bias-pull-up;
		};

		conf-ck_cd {
			pinmux = <PIN_PA22__SDMMC1_CK>,
			<PIN_PA30__SDMMC1_CD>;
			bias-disable;
		};
	};

	pinctrl_spi0_default: spi0_default {
		pinmux = <PIN_PA14__SPI0_SPCK>,
			 <PIN_PA15__SPI0_MOSI>,
			 <PIN_PA16__SPI0_MISO>;
		bias-disable;
	};

	pinctrl_charger_chglev: charger_chglev {
		pinmux = <PIN_PA12__GPIO>;
		bias-disable;
	};

	pinctrl_charger_irq: charger_irq {
		pinmux = <PIN_PB13__GPIO>;
		bias-disable;
	};

	pinctrl_charger_lbo: charger_lbo {
		pinmux = <PIN_PC8__GPIO>;
		bias-pull-up;
	};
};
#endif
